Previous SMB are dependent on NetBIOS over TCP. Therefore,  SMB port(TCP: 445, 139, UDP: 137,138) and NetBIOS (TCP: 139, UDP: 137,138) need to enumerated. Note that that used NetBIOS and SMB ports coincide since SMB use some of these ports in older implementation.

* SMB cheatsheet:
	* https://www.willhackforsushi.com/sec504/SMB-Access-from-Linux.pdf
	* https://book.hacktricks.xyz/network-services-pentesting/pentesting-smb
* Tools: `smbclient`, `CrackMapExec`, `SMBMap`, `Impacket`, `psexec.py`, `smbexec.py`, `responder`

* Use `impacket-smbclient` to connect to SMB.
	* Alternative is `smbclient [-N] -L \\\\<ip>\\<share>`
* Enumeration using nmap: `sudo nmap <ip> -sV -sC -p139,445`
* [Enumeration using nbtscan](https://www.kali.org/tools/nbtscan/): Example: `nbtscan -r  <ip>`
* Enumeration using nmap NSE scripts: Directory `/usr/share/nmap/scripts/smb*` contains various SMB enumeration scripts.
* SMB enumeration within windows environments: Example: `net view \\<domain controller> /all`
* [enum4linux](https://www.kali.org/tools/enum4linux/) : Enum4linux is a tool for enumerating information from Windows and Samba systems
	* `enum4linux <ip> [-A | -a]`
	* Alternative using enum4linux-ng: `./enum4linux-ng.py <ip> -A`
* Using RPCclient: `rpcclient -U "" <ip>`
	* Queries: `srvinfo`, `enumdomains`, `querydominfo`, `netshareenumall`, `netsharegetinfo <share>`, `enumdomusers`, `queryuser <RID>`, `querygroup`
	* https://www.samba.org/samba/docs/current/man-html/rpcclient.1.html
* Impacketâ€™s samrdump.py: Communicates with the Security Account Manager Remote (SAMR) interface to list system user accounts, available resource shares, and other sensitive information.
	* `samrdump.py <ip>`
* smbmap: List share drives, drive permissions, share contents, upload/download functionality, file name auto-download pattern matching, and even execute remote commands.
	* List shares: `smbmap -H <ip>`
* CrackMapExec for enumeration and password spraying.
	* List shares: `crackmapexec smb <ip> --shares -u '' -p ''`
	* Password spraying: `crackmapexec smb <ip> -u <users file> -p <password> --local-auth`
	* Command execution: `crackmapexec smb <ip> -u <user> -p <password> -[x|X] '<command>' --exec-method smbexec`
	* List logged-on users: `crackmapexec smb <ip>/24 -u <user> -p <password> --loggedon-users`
	* Dump SAM database: `crackmapexec smb <ip> -u <user> -p <password> --sam`
	* Pass the hash: `crackmapexec smb <ip> -u <user> -H <hash>`
* Metasploit
* If you have access to an SMB share(s) then you can use smbget to recursively download folders and files:
	* `smbget -U DOMAIN/user[%password] --recursive smb://<IP>/<share>`
* Can use ntlm hash stealing using LLMNR, NBT-NS, MDNS poisoning and ntlm relay attacks from [[Windows local password attacks]]

